<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Интерактивная Анатомия Сердца (Реалистичная)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            /* Сделали фон чуть светлее и с красноватым оттенком для атмосферы */
            background: radial-gradient(circle at center, #2c1e1e, #0a0a0a);
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            display: block;
        }

        /* Информационная панель */
        #info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 340px;
            background: rgba(30, 30, 30, 0.85); /* Чуть прозрачнее */
            backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            transform: translateX(120%);
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            border-left: 6px solid #ff5252; /* Ярче цвет границы */
            z-index: 10;
            color: #fff;
        }

        #info-panel.active {
            transform: translateX(0);
        }

        #info-title {
            margin: 0 0 12px 0;
            color: #ffeba7;
            font-size: 22px;
            font-weight: 700;
            border-bottom: 2px solid #555;
            padding-bottom: 12px;
        }

        #info-desc {
            color: #eeeeee; /* Светлее текст */
            font-size: 16px;
            line-height: 1.6;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Подсказка */
        #tooltip {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.7);
            color: #fff;
            padding: 12px 24px;
            border-radius: 30px;
            border: 1px solid #444;
            font-size: 14px;
            pointer-events: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            opacity: 0;
            animation: fadeIn 1s 1s forwards;
            text-align: center;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
            }
        }

        /* Loading */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #fff;
            font-weight: 500;
            display: none;
        }
    </style>
</head>
<body>

<div id="loading">Генерация анатомии...</div>

<div id="canvas-container"></div>

<div id="tooltip">Нажимайте на камеры и сосуды.<br>Модель сокращается в реальном времени.</div>

<div id="info-panel">
    <button class="close-btn" onclick="closePanel()">&times;</button>
    <h2 id="info-title">Название</h2>
    <p id="info-desc">Описание</p>
</div>

<!-- Подключаем Three.js через CDN -->
<script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import {OrbitControls} from 'three/addons/controls/OrbitControls.js';

    // --- ДАННЫЕ СЕРДЦА ---
    const heartData = {
        "LeftVentricle": {
            title: "Левый желудочек (Ventriculus sinister)",
            desc: "Самая мощная камера сердца. Имеет толстые мышечные стенки, так как именно отсюда обогащенная кислородом кровь выталкивается в аорту и разносится по всему организму под высоким давлением."
        },
        "RightVentricle": {
            title: "Правый желудочек (Ventriculus dexter)",
            desc: "Принимает венозную кровь из правого предсердия и перекачивает её через легочный ствол в легкие для насыщения кислородом. Его стенки тоньше левого."
        },
        "LeftAtrium": {
            title: "Левое предсердие (Atrium sinistrum)",
            desc: "Располагается сзади и сверху. Принимает насыщенную кислородом кровь от легких через четыре легочные вены."
        },
        "RightAtrium": {
            title: "Правое предсердие (Atrium dextrum)",
            desc: "Сюда впадают полые вены, приносящие венозную кровь от всего организма. Отсюда кровь поступает в правый желудочек."
        },
        "Aorta": {
            title: "Аорта (Aorta)",
            desc: "Крупнейший артериальный сосуд тела. Образует характерную дугу над сердцем, от которой отходят артерии к голове и рукам, а затем спускается вниз, питая всё тело."
        },
        "PulmonaryArtery": {
            title: "Легочный ствол (Truncus pulmonalis)",
            desc: "Выходит из правого желудочка и несет венозную кровь к легким. Делится на правую и левую легочные артерии."
        },
        "SuperiorVenaCava": {
            title: "Верхняя полая вена (Vena cava superior)",
            desc: "Толстый короткий сосуд, собирающий венозную кровь от головы, шеи и рук, и впадающий в правое предсердие сверху."
        }
    };

    // --- СЦЕНА ---
    const container = document.getElementById('canvas-container');
    const scene = new THREE.Scene();

    // Настройка камеры
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(0, 2, 16);

    const renderer = new THREE.WebGLRenderer({antialias: true, alpha: true});
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.SoftShadowMap;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.3; // Увеличили экспозицию (было 0.9)
    container.appendChild(renderer.domElement);

    // --- СВЕТ (Ярче и объемнее) ---
    // Общий заполняющий свет (белый)
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(ambientLight);

    // Основной рисующий свет (теплый)
    const keyLight = new THREE.SpotLight(0xfff0dd, 25);
    keyLight.position.set(8, 12, 10);
    keyLight.angle = Math.PI / 5;
    keyLight.penumbra = 0.3;
    keyLight.castShadow = true;
    keyLight.shadow.bias = -0.0001;
    scene.add(keyLight);

    // Фронтальный заполняющий свет (чтобы убрать черноту спереди)
    const frontLight = new THREE.DirectionalLight(0xffffff, 1.2);
    frontLight.position.set(0, 2, 10);
    scene.add(frontLight);

    // Красный подсвет снизу (оставили для объема, но ярче)
    const bottomLight = new THREE.PointLight(0xff3333, 8, 25);
    bottomLight.position.set(0, -6, 2);
    scene.add(bottomLight);

    // Холодный контурный свет (ярче)
    const rimLight = new THREE.SpotLight(0xeefeff, 15);
    rimLight.position.set(-10, 5, -5);
    rimLight.lookAt(0, 0, 0);
    scene.add(rimLight);

    // --- УПРАВЛЕНИЕ ---
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 8;
    controls.maxDistance = 30;

    // --- ГРУППА СЕРДЦА ---
    const heartGroup = new THREE.Group();
    scene.add(heartGroup);

    // --- МАТЕРИАЛЫ (Сделали чуть светлее базовые цвета) ---
    // Материал сердечной мышцы (Миокард)
    const muscleMaterial = new THREE.MeshPhysicalMaterial({
        color: 0x900000,        // Чуть светлее красный
        roughness: 0.45,        // Меньше бликов - больше матовости
        metalness: 0.1,
        clearcoat: 0.4,
        clearcoatRoughness: 0.2,
        sheen: 0.3,
        sheenColor: 0xff8888,   // Розоватый блеск
        side: THREE.DoubleSide
    });

    // Материал вен
    const veinMaterial = new THREE.MeshPhysicalMaterial({
        color: 0x4a6b7c,        // Светлее синий
        roughness: 0.5,
        metalness: 0.1,
        clearcoat: 0.3
    });

    // Материал аорты
    const aortaMaterial = new THREE.MeshPhysicalMaterial({
        color: 0xc43e3e,        // Светлее красный
        roughness: 0.4,
        clearcoat: 0.2
    });

    // Материал жира (желтоватые прожилки)
    const fatMaterial = new THREE.MeshStandardMaterial({
        color: 0xeeddcc,
        roughness: 0.8
    });

    // --- ФУНКЦИЯ ИСКАЖЕНИЯ ГЕОМЕТРИИ (ORGANIC NOISE) ---
    function distortGeometry(geometry, intensity = 0.5, freq = 1.0, seed = 0) {
        const posAttribute = geometry.attributes.position;
        const vertex = new THREE.Vector3();

        for (let i = 0; i < posAttribute.count; i++) {
            vertex.fromBufferAttribute(posAttribute, i);

            // Создаем "бугристость"
            const noise = Math.sin(vertex.x * freq + seed) +
                    Math.cos(vertex.y * freq + seed) +
                    Math.sin(vertex.z * freq + seed);

            const factor = 1 + noise * intensity * 0.1;

            vertex.multiplyScalar(factor);
            posAttribute.setXYZ(i, vertex.x, vertex.y, vertex.z);
        }
        geometry.computeVertexNormals();
        return geometry;
    }

    // --- СОЗДАНИЕ КАМЕР СЕРДЦА ---

    // 1. Левый желудочек (Основа - вытянутый конус/сфера)
    let lvGeo = new THREE.IcosahedronGeometry(2.5, 6);
    lvGeo.scale(0.9, 1.4, 0.9); // Вытягиваем вниз
    lvGeo.translate(0.5, -1, 0); // Смещаем
    distortGeometry(lvGeo, 1.2, 1.5, 10); // Сильное искажение
    const leftVentricle = new THREE.Mesh(lvGeo, muscleMaterial.clone());
    leftVentricle.name = "LeftVentricle";
    heartGroup.add(leftVentricle);

    // 2. Правый желудочек (Обернут вокруг левого)
    let rvGeo = new THREE.IcosahedronGeometry(2.2, 6);
    rvGeo.scale(1.1, 1.1, 0.8);
    rvGeo.rotateZ(0.5);
    rvGeo.translate(-1.2, -0.5, 0.5); // Слева и спереди
    distortGeometry(rvGeo, 1.5, 1.2, 20);
    const rightVentricle = new THREE.Mesh(rvGeo, muscleMaterial.clone());
    rightVentricle.name = "RightVentricle";
    heartGroup.add(rightVentricle);

    // 3. Левое предсердие (Сзади сверху)
    let laGeo = new THREE.SphereGeometry(1.4, 32, 32);
    laGeo.translate(1.0, 1.5, -0.5);
    distortGeometry(laGeo, 0.8, 2.0, 30);
    const leftAtrium = new THREE.Mesh(laGeo, muscleMaterial.clone());
    leftAtrium.name = "LeftAtrium";
    heartGroup.add(leftAtrium);

    // 4. Правое предсердие (Справа сверху)
    let raGeo = new THREE.SphereGeometry(1.5, 32, 32);
    raGeo.translate(-1.5, 1.2, 0.2);
    distortGeometry(raGeo, 0.9, 2.0, 40);
    const rightAtrium = new THREE.Mesh(raGeo, muscleMaterial.clone());
    rightAtrium.name = "RightAtrium";
    heartGroup.add(rightAtrium);

    // --- СОЗДАНИЕ СОСУДОВ (Curve Paths) ---

    function createVessel(path, radius, material, name) {
        const curve = new THREE.CatmullRomCurve3(path);
        const tubeGeo = new THREE.TubeGeometry(curve, 20, radius, 16, false);
        const mesh = new THREE.Mesh(tubeGeo, material);
        mesh.name = name;
        return mesh;
    }

    // 5. Аорта (Дуга)
    const aortaPath = [
        new THREE.Vector3(0.5, 1.5, 0),    // Выход из желудочка
        new THREE.Vector3(0.6, 3.5, 0),    // Вверх
        new THREE.Vector3(-0.5, 4.2, -0.5), // Дуга влево-назад
        new THREE.Vector3(-1.0, 3.5, -1.5), // Вниз сзади
        new THREE.Vector3(-1.0, 0, -2.0)    // Нисходящая
    ];
    const aorta = createVessel(aortaPath, 0.7, aortaMaterial, "Aorta");
    heartGroup.add(aorta);

    // 6. Легочный ствол (Перекрещивает аорту)
    const pulmPath = [
        new THREE.Vector3(-0.8, 1.0, 1.0), // Из правого желудочка
        new THREE.Vector3(-0.2, 2.5, 0.5), // Вверх-назад
        new THREE.Vector3(0.5, 2.8, -0.5)  // Разделение (уходит под дугу аорты)
    ];
    const pulmArtery = createVessel(pulmPath, 0.65, veinMaterial.clone(), "PulmonaryArtery");
    // Меняем цвет легочного ствола (венозная кровь -> синеватый, но артерия по структуре)
    pulmArtery.material.color.setHex(0x5d4037);
    heartGroup.add(pulmArtery);

    // 7. Верхняя полая вена
    const svcPath = [
        new THREE.Vector3(-2.0, 1.5, 0), // Вход в правое предсердие
        new THREE.Vector3(-2.2, 4.5, 0)  // Вверх
    ];
    const svc = createVessel(svcPath, 0.6, veinMaterial, "SuperiorVenaCava");
    heartGroup.add(svc);

    // Центрируем сердце
    new THREE.Box3().setFromObject(heartGroup).getCenter(heartGroup.position).multiplyScalar(-1);
    heartGroup.rotation.y = -0.3; // Легкий поворот для лучшего ракурса

    // --- ИНТЕРАКТИВНОСТЬ (Raycasting) ---
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let selectedObject = null;
    const originalEmissives = new Map();

    window.addEventListener('click', onMouseClick, false);
    window.addEventListener('mousemove', onMouseMove, false);

    function onMouseMove(event) {
        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(heartGroup.children);

        if (intersects.length > 0 && heartData[intersects[0].object.name]) {
            container.style.cursor = 'pointer';
        } else {
            container.style.cursor = 'default';
        }
    }

    function onMouseClick(event) {
        if (event.target.closest('#info-panel') || event.target.closest('.close-btn')) return;

        mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;

        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(heartGroup.children);

        if (intersects.length > 0) {
            let target = intersects[0].object;
            if (heartData[target.name]) {
                highlightObject(target);
                showInfo(target.name);
            }
        } else {
            closePanel();
            resetHighlight();
        }
    }

    function highlightObject(object) {
        resetHighlight();
        selectedObject = object;

        if (!originalEmissives.has(object.uuid)) {
            originalEmissives.set(object.uuid, object.material.emissive.getHex());
        }

        // Яркое свечение при выборе
        object.material.emissive.setHex(0xff5555); // Ярче подсветка выделения
        object.material.emissiveIntensity = 0.6;
    }

    function resetHighlight() {
        if (selectedObject) {
            const originalHex = originalEmissives.get(selectedObject.uuid) || 0x000000;
            selectedObject.material.emissive.setHex(originalHex);
            selectedObject.material.emissiveIntensity = 1.0;
            selectedObject = null;
        }
    }

    // --- UI ЛОГИКА ---
    const panel = document.getElementById('info-panel');
    const titleEl = document.getElementById('info-title');
    const descEl = document.getElementById('info-desc');

    function showInfo(partName) {
        const data = heartData[partName];
        if (!data) return;
        titleEl.textContent = data.title;
        descEl.textContent = data.desc;
        panel.classList.add('active');
    }

    window.closePanel = function () {
        panel.classList.remove('active');
        resetHighlight();
    };

    // --- АНИМАЦИЯ (БИЕНИЕ СЕРДЦА) ---
    function animate() {
        requestAnimationFrame(animate);
        controls.update();

        const time = Date.now() * 0.001;

        // Сложная формула биения (Быстрое сокращение - пауза)
        // Систола и Диастола
        const beat = Math.pow(Math.sin(time * 5), 63) * 0.15 + 1;

        // Применяем масштабирование ко всей группе
        heartGroup.scale.set(beat, beat, beat);

        // Легкое покачивание
        heartGroup.rotation.z = Math.sin(time) * 0.02;

        renderer.render(scene, camera);
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    animate();
</script>
</body>
</html>